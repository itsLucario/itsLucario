I"µ‚<p>In this article, we‚Äôll look at how to integrate a Spring Boot application with Apache Kafka and start sending and consuming messages from our application. We‚Äôll be going through each section with code examples.</p>

<h2 id="why-kafka">Why Kafka?</h2>

<p>Traditional messaging queues like ActiveMQ, RabbitMQ can handle high throughput usually used for long-running or background jobs and communicating between services.</p>

<p>Kafka is a stream-processing platform built by LinkedIn and currently developed under the umbrella of the Apache Software Foundation. Kafka aims to provide low-latency ingestion of large amounts of event data.</p>

<p>We can use Kafka when we have to move a large amount of data and process it in real-time. An example would be when we want to process user behavior on our website to generate product suggestions or monitor events produced by our micro-services.</p>

<p>Kafka is built from ground up with horizontal scaling in mind. We can scale by adding more brokers to the existing Kafka cluster.</p>

<h2 id="kafka-vocabulary">Kafka Vocabulary</h2>

<p>Let‚Äôs look at the key terminologies of Kafka:</p>

<ul>
  <li><strong>Producer</strong>: A producer is a client that sends messages to the Kafka server to the specified topic.</li>
  <li><strong>Consumer</strong>: Consumers are the recipients who receive messages from the Kafka server.</li>
  <li><strong>Broker</strong>: Brokers can create a Kafka cluster by sharing information using Zookeeper. A broker receives messages from producers and consumers fetch messages from the broker by topic, partition, and offset.</li>
  <li><strong>Cluster</strong>: Kafka is a distributed system. A Kafka cluster contains multiple brokers sharing the workload.</li>
  <li><strong>Topic</strong>: A topic is a category name to which messages are published and from which consumers can receive messages.</li>
  <li><strong>Partition</strong>: Messages published to a topic are spread across Kafka cluster into several partitions. Each partition can be associated with a broker to allow consumers to read from a topic in parallel.</li>
  <li><strong>Offset</strong>: Offset is a pointer to the last message that Kafka has already sent to a consumer.</li>
</ul>

<h2 id="configuring-a-kafka-client">Configuring a Kafka Client</h2>

<p>We should have a Kafka server running on our machine. If you don‚Äôt have Kafka setup on your system, take a look at the <a href="https://kafka.apache.org/quickstart">Kafka quickstart guide</a>. Once we have a Kafka server up and running, a Kafka client can be easily configured with Spring configuration in Java or even quicker with Spring Boot.</p>

<p>Let‚Äôs start by adding <code class="language-plaintext highlighter-rouge">spring-kafka</code> dependency to our <code class="language-plaintext highlighter-rouge">pom.xml</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
  &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;
  &lt;version&gt;2.5.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></div></div>

<h3 id="using-java-configuration">Using Java Configuration</h3>

<p>Let‚Äôs now see how to configure a Kafka client using Spring‚Äôs Java Configuration. For better understanding, we have separated <code class="language-plaintext highlighter-rouge">KafkaProducerConfig</code> and <code class="language-plaintext highlighter-rouge">KafkaConsumerConfig</code>.</p>

<p>Let‚Äôs have a look at the producer configuration first:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaProducerConfig</span> <span class="o">{</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${io.reflectoring.kafka.bootstrap-servers}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">bootstrapServers</span><span class="o">;</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">producerConfigs</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span>
      <span class="n">bootstrapServers</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">KEY_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span>
      <span class="nc">StringSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span>
      <span class="nc">StringSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">props</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">ProducerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">producerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;&gt;(</span><span class="n">producerConfigs</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">kafkaTemplate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;&gt;(</span><span class="n">producerFactory</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The above example shows how to configure the Kafka producer to send messages. <code class="language-plaintext highlighter-rouge">ProducerFactory</code> is responsible for creating Kafka Producer instances.</p>

<p><code class="language-plaintext highlighter-rouge">KafkaTemplate</code> helps us to send messages to their respective topic. We‚Äôll see more about <code class="language-plaintext highlighter-rouge">KafkaTemplate</code> in the <a href="#sending-messages">Sending Messages</a> section.</p>

<p>In <code class="language-plaintext highlighter-rouge">producerConfigs()</code> we are configuring a couple of properties:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">BOOTSTRAP_SERVERS_CONFIG</code> - Host and port on which Kafka is running.</li>
  <li><code class="language-plaintext highlighter-rouge">KEY_SERIALIZER_CLASS_CONFIG</code> - Serializer class to be used for the key.</li>
  <li><code class="language-plaintext highlighter-rouge">VALUE_SERIALIZER_CLASS_CONFIG</code> - Serializer class to be used for the value. We are using StringSerializer for both keys and values.</li>
</ul>

<p>Now that our producer config is ready, let‚Äôs create a configuration for the consumer:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaConsumerConfig</span> <span class="o">{</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${io.reflectoring.kafka.bootstrap-servers}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">bootstrapServers</span><span class="o">;</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">consumerConfigs</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span>
      <span class="n">bootstrapServers</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="o">,</span>
      <span class="nc">StringDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">props</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">ConsumerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">consumerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultKafkaConsumerFactory</span><span class="o">&lt;&gt;(</span><span class="n">consumerConfigs</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">KafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">ConcurrentMessageListenerContainer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">kafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;&gt;();</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setConsumerFactory</span><span class="o">(</span><span class="n">consumerFactory</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We use <code class="language-plaintext highlighter-rouge">ConcurrentKafkaListenerContainerFactory</code> to create containers for methods annotated with <code class="language-plaintext highlighter-rouge">@KafkaListener</code>. The <code class="language-plaintext highlighter-rouge">KafkaListenerContainer</code> receives all the messages from all topics or partitions on a single thread. We‚Äôll see more about message listener containers in the <a href="#consuming-messages">consuming messages</a> section.</p>

<h3 id="using-spring-boot-auto-configuration">Using Spring Boot Auto Configuration</h3>

<p>Spring Boot does most of the configuration automatically, so we can focus on building the listeners and producing the messages. It also provides the option to override the default configuration through <code class="language-plaintext highlighter-rouge">application.properties</code>. The Kafka configuration is controlled by the configuration properties with the prefix <code class="language-plaintext highlighter-rouge">spring.kafka.*</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring.kafka.bootstrap-servers=localhost:9092
spring.kafka.consumer.group-id=myGroup
</code></pre></div></div>

<h2 id="creating-kafka-topics">Creating Kafka Topics</h2>

<p>A topic must exist to start sending messages to it. Let`s now have a look at how we can create Kafka topics:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaTopicConfig</span> <span class="o">{</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">NewTopic</span> <span class="nf">topic1</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">TopicBuilder</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"reflectoring-1"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">NewTopic</span> <span class="nf">topic2</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">TopicBuilder</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"reflectoring-2"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>A <code class="language-plaintext highlighter-rouge">KafkaAdmin</code> bean is responsible for creating new topics in our broker. <strong>With Spring Boot, a <code class="language-plaintext highlighter-rouge">KafkaAdmin</code> bean is automatically registered.</strong></p>

<p>For a non Spring Boot application we have to manually register <code class="language-plaintext highlighter-rouge">KafkaAdmin</code> bean:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">KafkaAdmin</span> <span class="nf">admin</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">configs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
  <span class="n">configs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">AdminClientConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="o">...);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">KafkaAdmin</span><span class="o">(</span><span class="n">configs</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To create a topic, we register a <code class="language-plaintext highlighter-rouge">NewTopic</code> bean for each topic to the application context. If the topic already exists, the bean will be ignored. We can make use of <code class="language-plaintext highlighter-rouge">TopicBuilder</code> to create these beans. <code class="language-plaintext highlighter-rouge">KafkaAdmin</code> also increases the number of partitions if it finds that an existing topic has fewer partitions than <code class="language-plaintext highlighter-rouge">NewTopic.numPartitions</code>.</p>

<p>For the example code in the upcoming sections, we‚Äôll be creating 5 topics:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">reflectoring-1</code></li>
  <li><code class="language-plaintext highlighter-rouge">reflectoring-2</code></li>
  <li><code class="language-plaintext highlighter-rouge">reflectoring-3</code></li>
  <li><code class="language-plaintext highlighter-rouge">reflectoring-user</code></li>
  <li><code class="language-plaintext highlighter-rouge">reflectoring-others</code></li>
</ul>

<h2 id="sending-messages">Sending Messages</h2>

<h3 id="using-kafkatemplate">Using <code class="language-plaintext highlighter-rouge">KafkaTemplate</code></h3>

<p><code class="language-plaintext highlighter-rouge">KafkaTemplate</code> provides convenient methods to send messages to topics:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaSenderExample</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">kafkaTemplate</span><span class="o">;</span>
  <span class="o">...</span>

 	<span class="nd">@Autowired</span>
	<span class="nc">KafkaSenderExample</span><span class="o">(</span><span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">kafkaTemplate</span><span class="o">,</span> <span class="o">...)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">kafkaTemplate</span> <span class="o">=</span> <span class="n">kafkaTemplate</span><span class="o">;</span>
    <span class="o">...</span>
  <span class="o">}</span>

  <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">String</span> <span class="n">topicName</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">kafkaTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">topicName</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>All we need to do is to call the <code class="language-plaintext highlighter-rouge">sendMessage()</code> method with the message and the topic name as parameters.</p>

<p>Spring Kafka also allows us to configure an async callback:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaSenderExample</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kt">void</span> <span class="nf">sendMessageWithCallback</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">ListenableFuture</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">kafkaTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">topic1</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>

  <span class="n">future</span><span class="o">.</span><span class="na">addCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">ListenableFutureCallback</span><span class="o">&lt;</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">SendResult</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
      <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Message [{}] delivered with offset {}"</span><span class="o">,</span>
        <span class="n">message</span><span class="o">,</span>
        <span class="n">result</span><span class="o">.</span><span class="na">getRecordMetadata</span><span class="o">().</span><span class="na">offset</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="no">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Unable to deliver message [{}]. {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>the <code class="language-plaintext highlighter-rouge">send()</code> method of <code class="language-plaintext highlighter-rouge">KafkaTemplate</code> returns a <code class="language-plaintext highlighter-rouge">ListenableFuture&lt;SendResult&gt;</code>. We can register a <code class="language-plaintext highlighter-rouge">ListenableFutureCallback</code> with the listener to receive the result of the send and do some work within an execution context.</p>

<p>If we don‚Äôt want to work with <code class="language-plaintext highlighter-rouge">Future</code>s, we can register a <code class="language-plaintext highlighter-rouge">ProducerListener</code> instead:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaProducerConfig</span> <span class="o">{</span>
  <span class="nd">@Bean</span>
  <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">kafkaTemplate</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">kafkaTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;&gt;(</span><span class="n">producerFactory</span><span class="o">());</span>
  <span class="o">...</span>
  <span class="n">kafkaTemplate</span><span class="o">.</span><span class="na">setProducerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProducerListener</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">ProducerRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">producerRecord</span><span class="o">,</span> <span class="nc">RecordMetadata</span> <span class="n">recordMetadata</span><span class="o">)</span> <span class="o">{</span>
      <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ACK from ProducerListener message: {} offset:  {}"</span><span class="o">,</span>
        <span class="n">producerRecord</span><span class="o">.</span><span class="na">value</span><span class="o">(),</span>
        <span class="n">recordMetadata</span><span class="o">.</span><span class="na">offset</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">});</span>
  <span class="k">return</span> <span class="n">kafkaTemplate</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We configured <code class="language-plaintext highlighter-rouge">KafkaTemplate</code> with a <code class="language-plaintext highlighter-rouge">ProducerListener</code> which allows us to implement the <code class="language-plaintext highlighter-rouge">onSuccess()</code> and <code class="language-plaintext highlighter-rouge">onError()</code> methods.</p>

<h3 id="using-routingkafkatemplate">Using <code class="language-plaintext highlighter-rouge">RoutingKafkaTemplate</code></h3>

<p>We can use <code class="language-plaintext highlighter-rouge">RoutingKafkaTemplate</code> when we have <strong>multiple producers with different configurations</strong> and we want to select producer at runtime based on the topic name.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaProducerConfig</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">RoutingKafkaTemplate</span> <span class="nf">routingTemplate</span><span class="o">(</span><span class="nc">GenericApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ProducerFactory with Bytes serializer</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServers</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">KEY_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">StringSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">ByteArraySerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">bytesPF</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;&gt;(</span><span class="n">props</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">registerBean</span><span class="o">(</span><span class="nc">DefaultKafkaProducerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"bytesPF"</span><span class="o">,</span> <span class="n">bytesPF</span><span class="o">);</span>

    <span class="c1">// ProducerFactory with String serializer</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">StringSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">stringPF</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;&gt;(</span><span class="n">props</span><span class="o">);</span>


    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Pattern</span><span class="o">,</span> <span class="nc">ProducerFactory</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">".*-bytes"</span><span class="o">),</span> <span class="n">bytesPF</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"reflectoring-.*"</span><span class="o">),</span> <span class="n">stringPF</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">RoutingKafkaTemplate</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">RoutingKafkaTemplate</code> takes a map of <code class="language-plaintext highlighter-rouge">java.util.regex.Pattern</code> and <code class="language-plaintext highlighter-rouge">ProducerFactory</code> instances and routes messages to the first <code class="language-plaintext highlighter-rouge">ProducerFactory</code> matching a given topic name. If we have two patterns <code class="language-plaintext highlighter-rouge">ref.*</code> and <code class="language-plaintext highlighter-rouge">reflectoring-.*</code>, the pattern <code class="language-plaintext highlighter-rouge">reflectoring-.*</code> should be at the beginning because the <code class="language-plaintext highlighter-rouge">ref.*</code> pattern would ‚Äúoverride‚Äù it, otherwise.</p>

<p>In the above example, we have created two patterns <code class="language-plaintext highlighter-rouge">.*-bytes</code> and <code class="language-plaintext highlighter-rouge">reflectoring-.*</code>. The topic names ending with ‚Äò<code class="language-plaintext highlighter-rouge">-bytes</code>‚Äô and starting with <code class="language-plaintext highlighter-rouge">reflectoring-.*</code> will use <code class="language-plaintext highlighter-rouge">ByteArraySerializer</code> and <code class="language-plaintext highlighter-rouge">StringSerializer</code> respectively when we use <code class="language-plaintext highlighter-rouge">RoutingKafkaTemplate</code> instance.</p>

<h2 id="consuming-messages">Consuming Messages</h2>

<h3 id="message-listener">Message Listener</h3>

<p>As said earlier, a <code class="language-plaintext highlighter-rouge">KafkaMessageListenerContainer</code> receives all messages from all topics on a single thread.</p>

<p>A <code class="language-plaintext highlighter-rouge">ConcurrentMessageListenerContainer</code> assigns these messages to multiple <code class="language-plaintext highlighter-rouge">KafkaMessageListenerContainer</code> instances to provide multi-threaded capability.</p>

<h3 id="using-kafkalistener-at-method-level">Using <code class="language-plaintext highlighter-rouge">@KafkaListener</code> at Method Level</h3>

<p>The <code class="language-plaintext highlighter-rouge">@KafkaListener</code> annotation allows us to create listeners:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaListenersExample</span> <span class="o">{</span>

  <span class="nc">Logger</span> <span class="no">LOG</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">KafkaListenersExample</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"reflectoring-1"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">listener</span><span class="o">(</span><span class="nc">String</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"reflectoring-1, reflectoring-2"</span><span class="o">,</span> <span class="n">groupId</span> <span class="o">=</span> <span class="s">"reflectoring-group-2"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">commonListenerForMultipleTopics</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"MultipleTopicListener - {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To use this annotation we should add the <code class="language-plaintext highlighter-rouge">@EnableKafka</code> annotation on one of our <code class="language-plaintext highlighter-rouge">@Configuration</code> classes and it requires a listener container factory, which we have configured in <code class="language-plaintext highlighter-rouge">KafkaConsumerConfig.java</code>.</p>

<p>Using <code class="language-plaintext highlighter-rouge">@KafkaListener</code> will make this bean method a listener and wrap the bean in <code class="language-plaintext highlighter-rouge">MessagingMessageListenerAdapter</code>. We can also specify multiple topics for a single listener using topics attribute as shown above.</p>

<h3 id="using-kafkalistener-at-class-level">Using <code class="language-plaintext highlighter-rouge">@KafkaListener</code> at Class Level</h3>

<p>We can also use <code class="language-plaintext highlighter-rouge">@KafkaListener</code> annotation at class level. If we do so, we need to specify <code class="language-plaintext highlighter-rouge">@KafkaHandler</code> at the method level:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">"class-level"</span><span class="o">,</span> <span class="n">topics</span> <span class="o">=</span> <span class="s">"reflectoring-3"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">KafkaClassListener</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@KafkaHandler</span>
  <span class="kt">void</span> <span class="nf">listen</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"KafkaHandler[String] {}"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@KafkaHandler</span><span class="o">(</span><span class="n">isDefault</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">listenDefault</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"KafkaHandler[Default] {}"</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When the listener receives messages, it converts them into the target types and tries to match that type against the method signatures to find out which method to call.</p>

<p>In the example, messages of type <code class="language-plaintext highlighter-rouge">String</code> will be received by <code class="language-plaintext highlighter-rouge">listen()</code> and type <code class="language-plaintext highlighter-rouge">Object</code> will be received by <code class="language-plaintext highlighter-rouge">listenDefault()</code>. Whenever there is no match, the default handler (defined by <code class="language-plaintext highlighter-rouge">isDefault=true</code>) will be called.</p>

<h3 id="consuming-messages-from-a-specific-partition-with-an-initial-offset">Consuming Messages from a Specific Partition with an Initial Offset</h3>

<p>We can configure listeners to listen to multiple topics, partitions, and a specific initial offset.</p>

<p>For example, if we want to receive all the messages sent to a topic from the time of its creation on application startup we can set the initial offset to zero:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaListenersExample</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@KafkaListener</span><span class="o">(</span>
    <span class="n">groupId</span> <span class="o">=</span> <span class="s">"reflectoring-group-3"</span><span class="o">,</span>
    <span class="n">topicPartitions</span> <span class="o">=</span> <span class="nd">@TopicPartition</span><span class="o">(</span>
      <span class="n">topic</span> <span class="o">=</span> <span class="s">"reflectoring-1"</span><span class="o">,</span>
      <span class="n">partitionOffsets</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@PartitionOffset</span><span class="o">(</span><span class="n">partition</span> <span class="o">=</span> <span class="s">"0"</span><span class="o">,</span> <span class="n">initialOffset</span> <span class="o">=</span> <span class="s">"0"</span><span class="o">)</span> <span class="o">}))</span>
  <span class="kt">void</span> <span class="nf">listenToParitionWithOffset</span><span class="o">(</span>
    <span class="nd">@Payload</span> <span class="nc">String</span> <span class="n">message</span><span class="o">,</span>
    <span class="nd">@Header</span><span class="o">(</span><span class="nc">KafkaHeaders</span><span class="o">.</span><span class="na">RECEIVED_PARTITION_ID</span><span class="o">)</span> <span class="kt">int</span> <span class="n">partition</span><span class="o">,</span>
    <span class="nd">@Header</span><span class="o">(</span><span class="nc">KafkaHeaders</span><span class="o">.</span><span class="na">OFFSET</span><span class="o">)</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">)</span> <span class="o">{</span>
      <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Received message [{}] from partition-{} with offset-{}"</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="n">partition</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Since we have specified <code class="language-plaintext highlighter-rouge">initialOffset = "0"</code> in <code class="language-plaintext highlighter-rouge">listenToPartition</code> listener, we will receive all the messages starting from offset 0 every time we restart the application.</p>

<p>We can also retrieve some useful metadata about the consumed message using the <code class="language-plaintext highlighter-rouge">@Header()</code> annotation.</p>

<h3 id="filtering-messages">Filtering Messages</h3>

<p>Spring provides a strategy to filter messages before they reach our listeners:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">KafkaConsumerConfig</span> <span class="o">{</span>

  <span class="nd">@Bean</span>
  <span class="nc">KafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">ConcurrentMessageListenerContainer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span>
  <span class="nf">kafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;&gt;();</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setConsumerFactory</span><span class="o">(</span><span class="n">consumerFactory</span><span class="o">());</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setRecordFilterStrategy</span><span class="o">(</span><span class="n">record</span> <span class="o">-&gt;</span> <span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"ignored"</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Spring wraps the listener with a <code class="language-plaintext highlighter-rouge">FilteringMessageListenerAdapter</code>. It takes an implementation of <code class="language-plaintext highlighter-rouge">RecordFilterStrategy</code> in which we implement the filter method and the messages which won‚Äôt match get discarded before reaching the listener.</p>

<p>In the above example, we have added a filter to discard the messages which contain the word ‚Äúignored‚Äù.</p>

<h3 id="replying-with-sendto">Replying with <code class="language-plaintext highlighter-rouge">@SendTo</code></h3>

<p>Spring allows sending method‚Äôs return value to the specified destination with <code class="language-plaintext highlighter-rouge">@SendTo</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaListenersExample</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@KafkaListener</span><span class="o">(</span><span class="n">topics</span> <span class="o">=</span> <span class="s">"reflectoring-others"</span><span class="o">)</span>
  <span class="nd">@SendTo</span><span class="o">(</span><span class="s">"reflectoring-1"</span><span class="o">)</span>
  <span class="nc">String</span> <span class="nf">listenAndReply</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ListenAndReply [{}]"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"This is a reply sent after receiving message"</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The Spring Boot default configuration gives us a reply template. Since we are overriding the factory configuration above, the listener container factory must be provided with a <code class="language-plaintext highlighter-rouge">KafkaTemplate</code> by using <code class="language-plaintext highlighter-rouge">setReplyTemplate()</code> which is then used to send the reply.</p>

<p>In the above example, we are sending the reply message to the topic ‚Äúreflectoring-1‚Äù.</p>

<h2 id="custom-messages">Custom Messages</h2>

<p>Let‚Äôs now look at how to send/receive a Java object. We‚Äôll be sending and receiving <code class="language-plaintext highlighter-rouge">User</code> objects in our example.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="configuring-json-serializer--deserializer">Configuring JSON Serializer &amp; Deserializer</h3>

<p>To achieve this, we must configure our producer and consumer to use a JSON serializer and deserializer:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaProducerConfig</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">ProducerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="nf">userProducerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">configProps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ProducerConfig</span><span class="o">.</span><span class="na">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="o">,</span> <span class="nc">JsonSerializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultKafkaProducerFactory</span><span class="o">&lt;&gt;(</span><span class="n">configProps</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="nf">userKafkaTemplate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;&gt;(</span><span class="n">userProducerFactory</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">KafkaConsumerConfig</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="nc">ConsumerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="nf">userConsumerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="n">bootstrapServers</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">GROUP_ID_CONFIG</span><span class="o">,</span> <span class="s">"reflectoring-user"</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultKafkaConsumerFactory</span><span class="o">&lt;&gt;(</span>
      <span class="n">props</span><span class="o">,</span>
      <span class="k">new</span> <span class="nf">StringDeserializer</span><span class="o">(),</span>
      <span class="k">new</span> <span class="nc">JsonDeserializer</span><span class="o">&lt;&gt;(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="nf">userKafkaListenerContainerFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="o">&lt;&gt;();</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setConsumerFactory</span><span class="o">(</span><span class="n">userConsumerFactory</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Spring Kafka provides <code class="language-plaintext highlighter-rouge">JsonSerializer</code> and <code class="language-plaintext highlighter-rouge">JsonDeserializer</code> implementations that are based on the Jackson JSON object mapper. It allows us to convert any Java object to <code class="language-plaintext highlighter-rouge">bytes[]</code>.</p>

<p>In the above example, we are creating one more <code class="language-plaintext highlighter-rouge">ConcurrentKafkaListenerContainerFactory</code> for JSON serialization. In this, we have configured <code class="language-plaintext highlighter-rouge">JsonSerializer.class</code> as our value serializer in the producer config and <code class="language-plaintext highlighter-rouge">JsonDeserializer&lt;&gt;(User.class)</code> as our value deserializer in the consumer config.</p>

<p>For this, we are creating a separate Kafka listener container <code class="language-plaintext highlighter-rouge">userKafkaListenerContainerFactory</code>. If we have multiple Java object types to be serialized/deserialized, we have to create a listener container for each type as shown above.</p>

<h3 id="sending-java-objects">Sending Java objects</h3>

<p>Now that we have configured our serializer and deserializer, we can send a <code class="language-plaintext highlighter-rouge">User</code> object using the <code class="language-plaintext highlighter-rouge">KafkaTemplate</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaSenderExample</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">KafkaTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="n">userKafkaTemplate</span><span class="o">;</span>

  <span class="kt">void</span> <span class="nf">sendCustomMessage</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">,</span> <span class="nc">String</span> <span class="n">topicName</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">userKafkaTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">topicName</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="receiving-java-objects">Receiving Java Objects</h3>

<p>We can listen to <code class="language-plaintext highlighter-rouge">User</code> objects by using the <code class="language-plaintext highlighter-rouge">@KafkaListener</code> annotation:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">KafkaListenersExample</span> <span class="o">{</span>

  <span class="nd">@KafkaListener</span><span class="o">(</span>
    <span class="n">topics</span> <span class="o">=</span> <span class="s">"reflectoring-user"</span><span class="o">,</span>
    <span class="n">groupId</span><span class="o">=</span><span class="s">"reflectoring-user"</span><span class="o">,</span>
    <span class="n">containerFactory</span><span class="o">=</span><span class="s">"userKafkaListenerContainerFactory"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">listener</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"CustomUserListener [{}]"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Since we have multiple listener containers, we are specifying which container factory to use.</p>

<p>If we don‚Äôt specify the <code class="language-plaintext highlighter-rouge">containerFactory</code> attribute it defaults to <code class="language-plaintext highlighter-rouge">kafkaListenerContainerFactory</code> which uses <code class="language-plaintext highlighter-rouge">StringSerializer</code> and <code class="language-plaintext highlighter-rouge">StringDeserializer</code> in our case.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we covered how we can leverage the Spring support for Kafka. Build Kafka based messaging with code examples that can help to get started quickly.</p>

<p>You can play around with the code <a href="https://github.com/thombergs/code-examples/tree/master/spring-boot/spring-events">on GitHub</a>.</p>
:ET